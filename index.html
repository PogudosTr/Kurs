<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Транскрибатор</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">
    <h1>Транскрибатор</h1>
    
    <div class="section">
        <h2>Голос</h2>
        <button id="recordButton">Запись</button>
        <button id="stopButton" disabled>Стоп</button>
    </div>

    <div class="section">
        <h2>Файл</h2>
        <input type="file" id="fileInput" accept="audio/*">
        <button id="uploadButton">Обработать</button>
    </div>

    <div id="status">Готов к работе</div>

    <div class="section">
        <div class="history-header">
            <h2>История</h2>
            <button id="clearHistoryButton" class="clear-all" style="display:none">Очистить всё</button>
        </div>
        <div id="historyList">
            <p id="noDataText" style="color:#999; font-size:0.9rem">Пусто</p>
        </div>
    </div>
</div>

<script>
    const recordButton = document.getElementById('recordButton');
    const stopButton = document.getElementById('stopButton');
    const fileInput = document.getElementById('fileInput');
    const uploadButton = document.getElementById('uploadButton');
    const statusDiv = document.getElementById('status');
    const historyList = document.getElementById('historyList');
    const noDataText = document.getElementById('noDataText');
    const clearHistoryButton = document.getElementById('clearHistoryButton');

    const STORAGE_KEY = 'simple_transcription_v1';
    let transcriptionsHistory = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(transcriptionsHistory)); }

    function renderHistory() {
        if (transcriptionsHistory.length > 0) {
            noDataText.style.display = 'none';
            clearHistoryButton.style.display = 'inline';
        } else {
            noDataText.style.display = 'block';
            clearHistoryButton.style.display = 'none';
            historyList.innerHTML = '';
            historyList.appendChild(noDataText);
            return;
        }

        historyList.innerHTML = '';
        transcriptionsHistory.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div class="history-item-header">
                    <span>${item.fileName} — ${item.time}</span>
                    <button class="delete-btn" onclick="deleteItem(${index})">удалить</button>
                </div>
                <p>${item.text}</p>
            `;
            historyList.appendChild(div);
        });
    }

    window.deleteItem = (index) => {
        if(confirm('Удалить запись?')) {
            transcriptionsHistory.splice(index, 1);
            save();
            renderHistory();
        }
    };

    clearHistoryButton.onclick = () => {
        if(confirm('Очистить всю историю?')) {
            transcriptionsHistory = [];
            save();
            renderHistory();
        }
    };

    let mediaRecorder;
    let audioChunks = [];

    recordButton.onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                send(blob, `record_${Date.now()}.webm`);
                stream.getTracks().forEach(t => t.stop());
            };
            mediaRecorder.start();
            recordButton.disabled = true;
            stopButton.disabled = false;
            statusDiv.textContent = 'Запись идет...';
        } catch (err) {
            statusDiv.className = 'status-error';
            statusDiv.textContent = 'Нет доступа к микрофону';
        }
    };

    stopButton.onclick = () => {
        mediaRecorder.stop();
        stopButton.disabled = true;
        recordButton.disabled = false;
        statusDiv.textContent = 'Обработка...';
    };

    uploadButton.onclick = () => {
        const file = fileInput.files[0];
        if (!file) return alert('Выберите файл');
        statusDiv.textContent = 'Загрузка...';
        send(file, file.name);
    };

    function send(blob, name) {
        const fd = new FormData();
        fd.append('audio_file', blob, name);
        fetch('upload.php', { method: 'POST', body: fd })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const now = new Date();
                    transcriptionsHistory.unshift({
                        time: now.toLocaleDateString() + ' ' + now.toLocaleTimeString(),
                        text: data.transcription,
                        fileName: name
                    });
                    save();
                    renderHistory();
                    statusDiv.className = 'status-success';
                    statusDiv.textContent = 'Готово';
                } else {
                    statusDiv.className = 'status-error';
                    statusDiv.textContent = 'Ошибка сервера';
                }
            })
            .catch(() => {
                statusDiv.className = 'status-error';
                statusDiv.textContent = 'Ошибка сети';
            });
    }

    renderHistory();
</script>

</body>
</html>