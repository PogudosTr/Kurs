<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—É–¥–∏–æ-—Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ç–æ—Ä –Ω–∞ PHP & Whisper</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>üéôÔ∏è –ó–∞–ø–∏—Å—å –∏ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –ê—É–¥–∏–æ</h1>
    
    <h2>üî¥ –ó–∞–ø–∏—Å—å —Å –ú–∏–∫—Ä–æ—Ñ–æ–Ω–∞</h2>
    <div id="controls">
        <button id="recordButton">–ù–∞—á–∞—Ç—å –ó–∞–ø–∏—Å—å</button>
        <button id="stopButton" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ó–∞–ø–∏—Å—å</button>
    </div>

    <h2>üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –§–∞–π–ª</h2>
    <div id="upload-controls">
        <input type="file" id="fileInput" accept="audio/*">
        <button id="uploadButton">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <div id="status" class="status-ready">–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø–∏—Å–∏ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–µ.</div>
    <div id="transcription-result">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏:</h2>
        <p id="resultText">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç...</p>
    </div>

    <script>
        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const statusDiv = document.getElementById('status');
        const resultText = document.getElementById('resultText');

        let mediaRecorder;
        let audioChunks = [];
        let stream;

        // --- 1. –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å ---
        recordButton.onclick = async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    uploadAudio(audioBlob, 'voice_message.webm');
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                recordButton.disabled = true;
                stopButton.disabled = false;
                uploadButton.disabled = true;
                statusDiv.className = 'status-recording';
                statusDiv.textContent = '–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...';
                resultText.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏...';

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', err);
                statusDiv.className = 'status-error';
                statusDiv.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.';
            }
        };

        // --- 2. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å ---
        stopButton.onclick = () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                recordButton.disabled = true;
                stopButton.disabled = true;
                statusDiv.className = 'status-processing';
                statusDiv.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è...';
            }
        };
        
        // --- 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ---
        uploadButton.onclick = () => {
            const file = fileInput.files[0];
            
            if (!file) {
                statusDiv.className = 'status-error';
                statusDiv.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.';
                return;
            }
            
            recordButton.disabled = true;
            stopButton.disabled = true;
            uploadButton.disabled = true;
            statusDiv.className = 'status-processing';
            statusDiv.textContent = `–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ "${file.name}"...`;
            resultText.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏...';

            uploadAudio(file, file.name);
        };

        // --- 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä ---
        function uploadAudio(audioBlob, fileName) {
            const formData = new FormData();
            formData.append('audio_file', audioBlob, fileName);

            fetch('upload.php', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞
                recordButton.disabled = false;
                uploadButton.disabled = false;
                
                if (data.success) {
                    statusDiv.className = 'status-success';
                    statusDiv.textContent = '–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
                    resultText.textContent = data.transcription;
                } else {
                    statusDiv.className = 'status-error';
                    statusDiv.textContent = '–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
                    resultText.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é.';
                }
            })
            .catch(error => {
                recordButton.disabled = false;
                uploadButton.disabled = false;

                statusDiv.className = 'status-error';
                statusDiv.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.';
                resultText.textContent = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + error.message;
            });
        }
    </script>
</body>
</html>